{% extends "layout_main.html" %}
{% load i18n %}
{% load static %}
{% load summit_tags %}
{% load payment_tags %}

{% block extra_styles %}
<style>
    table tr.new_ticket {
        background-color: lightgreen;
    }
    table tr.active_ticket, table tr.active_user {
        background-color: bisque;
    }
</style>
{% endblock %}

{% block header.search %}
    <li class="search__container">
        <div class="search">
            {% block header.search.field %}
                <input type="text" id="find_by_code" name="find_by_code" value="{{ request.GET.code }}" placeholder="Поиск билета по коду">
            {% endblock %}
            {% block header.search.filter %}
            {% endblock %}
        </div>
    </li>
{% endblock %}

{% block header.top.h1 %}
    <h1 id="summit-title">
        {% trans "Tickets" %}
    </h1>
{% endblock %}

{% block header.buttons.filter %}
{% endblock %}

{% block header.buttons %}
{% endblock %}

{% block main.content %}
    <div class="ticket-list">
        {% regroup tickets by summit.type as summit_type_list %}
        {% for summit_type in summit_type_list %}
            <h2>{{ summit_type.grouper }}</h2>
            {% regroup summit_type.list by summit as summit_list %}
            {% for summit in summit_list %}
                <h3>
                    {{ summit.grouper }}
                </h3>
                <table class="tickets_table">
                    <tr>
                        <th>{% trans "Title" %}</th>
                        <th>{% trans "Creator" %}</th>
                        <th>{% trans "Status" %}</th>
                        <th>{% trans "Attachment" %}</th>
                        <th></th>
                    </tr>
                    {% for ticket in summit.list %}
                        <tr{% if ticket.is_new %} class="new_ticket"{% endif %}>
                            <td><span data-id="{{ ticket.id }}" class="ticket_title">{{ ticket.title }}</span></td>
                            <td>
                                <a href="{{ ticket.owner.get_absolute_url }}">{{ ticket.owner }}</a>
                            </td>
                            <td style="color:{% if ticket.status == 'complete' %}
                                green
                            {% elif ticket.status == 'progress' %}
                                blue
                            {% endif %};">
                                {{ ticket.get_status_display }}
                            </td>
                            <td>
                                {% if ticket.attachment %}
                                    <a href="{{ ticket.attachment.url }}">{% trans "Download" %}</a>
                                {% endif %}
                            </td>
                            <td><a href="{{ ticket.get_absolute_url }}">{% trans "Detail" %}</a></td>
                        </tr>
                    {% endfor %}
                    <tr>
                    </tr>
                </table>
            {% endfor %}
        {% endfor %}
    </div>
    <div id="ticket_users"></div>
{% endblock %}

{% block extra_scripts %}
    <script src='{% static "js/tickets.js" %}'></script>
    <script type="text/template" id="users_tml">
    <table>
        <tr>
            <th>{% trans "Name" %}</th>
            <th>{% trans "Code" %}</th>
        </tr>
        <% ankets.forEach(function(anket) { %>
            <tr<% if (anket.is_active) { %> class='active_user'<% } %>>
                <td><%=anket.user.fullname %></td>
        <td><a href="/api/v1.0/generate_code/<%= anket.code %>.pdf?code=<%= anket.code %>"><%=anket.code %></a></td>
            </tr>
        <% }) %>
        <tr></tr>
    </table>
    </script>
{% endblock %}
