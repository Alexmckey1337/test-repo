image: docker:latest
services:
  - docker:dind

before_script:
    - docker login -u amirr -p $MCI_BUILD_TOKEN $MCI_REGISTRY

stages:
  - build
  - test

prepare:
  stage: build
  script:
    - docker build -t reg.sobsam.com/vocrm:latest .
    - docker push reg.sobsam.com/vocrm:latest

pytest:
  stage: test
  services:
  - name: docker:dind
  - name: postgres:10
    alias: db
  - name: redis:latest
    alias: redis
  script:
    - docker pull reg.sobsam.com/vocrm:latest
    - docker run -d --name db reg.sobsam.com/postgres:10
    - docker run -d --name redis redis:latest
    - docker ps && sleep 10
    - docker run --rm -e POSTGRES_USER='postgres' -e POSTGRES_PASSWORD='' -e POSTGRES_DB='test_crm_db' -e DJANGO_SETTINGS_MODULE='edem.settings.test' -e POSTGRES_HOST='db' --name pytest --link db --link redis reg.sobsam.com/vocrm:latest python manage.py test